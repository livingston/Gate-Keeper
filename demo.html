<!doctype html>
<html>
<head>
  <meta charset='utf-8' />
  <title>Gate Keeper</title>
  
  <link rel='stylesheet' href='css/styles.css' />
</head>
<body>
  <div id='wrapper'>
    <h1>Gate Keeper</h1>
    
    <div id='flash_container' class='container'>
      <object  id="iembedflash" classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=7,0,0,0" width="320" height="240">
        <param name="movie" value="camcanvas.swf" />
        <param name="quality" value="high" />
        <param name="allowScriptAccess" value="always" />
        <embed  allowScriptAccess="always"  id="embedflash" src="camcanvas.swf" quality="high" width="320" height="240" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" mayscript="true" wmode='transparent' />
      </object>
    </div>
    <div id='canvas_container' class='container'>
      <canvas id='canvas' width='320' height='240'></canvas>
    </div>
    
    <button id='capture'>Capture</button>
  </div>
  
  <script>
    var cam = document.getElementById("embedflash"),
        gCanvas = document.getElementById("canvas"),
        gCtx = gCanvas.getContext('2d'),
        gW = gCanvas.width, gH = gCanvas.height,
        imageData = gCtx.getImageData( 0, 0, gW, gH)
        imageDataBuffer = gCtx.getImageData( 0, 0, gW, gH),
        ii=0, jj=0, c=0,
        btnCapture = document.getElementById("capture");

    
    function passLine(stringPixels) {
      var coll = stringPixels.split("-");
      
      for(var i=0;i<320;i++) {
        var intVal = parseInt(coll[i]);
        
        r = (intVal >> 16) & 0xff;
        g = (intVal >> 8) & 0xff;
        b = (intVal ) & 0xff;
        
        imageData.data[c+0]=r;
        imageData.data[c+1]=g;
        imageData.data[c+2]=b;
        imageData.data[c+3]=255;
        
        c+=4;
      } 
      
      if(c>=320*240*4) {
        c=0;
        
        gCtx.putImageData(imageData, 0,0);
      }
    };
    
    btnCapture.addEventListener('click', function () {
      updateCanvas();
    }, false);
    
    var updateCanvas = function () {
      cam.ccCapture();
      
      setTimeout(updateCanvas, 300);
    };
  </script>
</body>
</html>